
#automation

cd vagrant-ansible-infra

vagrant up


Prerequisites
A Linux workstation (I am using Ubuntu 20.10) with At least 8 GB of RAM and 15 GB of free hard disk space for the virtual machines.
lsb_release -a
Vagrant 2.2.16
wget https://releases.hashicorp.com/vagrant/2.2.16/vagrant_2.2.16_x86_64.deb
sudo apt install ./vagrant_2.2.16_x86_64.deb
VirtualBox 6.1.22 or above
sudo apt install virtualbox
Ansible 2.9.9
sudo apt-add-repository --yes --update ppa:ansible/ansible
sudo apt install ansible
File Structure
The code used to create a Kubernetes Cluster with Vagrant and Ansible is composed of:

.vagrant/: hidden directory for Vagrant tracking. It includes a Vagrant generated Inventory file: vagrant_ansible_inventory that is used by Ansible to match virtual machines and roles.
add_packages: Ansible playbook to install/remove packages using APT in an Ubuntu system.
roles/
common/: installs the needed packages for Kubernetes (delegating in add_packages) and configures the common settings for Kubernetes master and nodes.
k8s/master/: Ansible playbook to configure a Kubernetes master, it uses the common playbook for shared components between the Kubernetes master and the nodes.
k8s/node/: Ansible playbook to configure a Kubernetes node, it uses the common playbook for shared components between the Kubernetes master and the nodes.
k8s.yml: Ansible playbook that uses the Kubernetes ansible roles.
ditwl-k8s-01-join-command: this file is generated by the Kubernetes master and includes a temporary token and the command needed to join Kubernetes nodes to the cluster.
Vagrantfile: contains the definition of the machines (CPU, memory, network and Ansible playbook and properties)

Kubernetes Network Overview
![Inkedansible-kubernetes-vagrant](https://user-images.githubusercontent.com/18261897/202597175-87a6f374-0938-43db-a3ad-5918ba862296.jpg)

After installing a Kubernetes Cluster it is recommended to:

Check the health of the cluster
Check networking status
Install kubectl to administer the cluster using a command line
Install the Kubernetes Dashboard

ssh k8s-m-1

To check that Calico Networking is running, open a Vagrant SSH to k8s-m-1 and execute: 

kubectl get pods â€“all-namespaces

Install kubectl to administer the Kubernetes Cluster from your development host

sudo apt-get update && sudo apt-get install -y apt-transport-https
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubectl

Copy the Kubernetes config to your local home .kube dir

#Create the configuration directory
$ mkdir -p ~/.kube
#Find the SSH port of the k8s-m-1 server
$ vagrant port k8s-m-1
The forwarded ports for the machine are listed below. Please note that
these values may differ from values configured in the Vagrantfile if the
provider supports automatic port collision detection and resolution.
    22 (guest) => 2222 (host)
#Copy the file using scp (ssh password is vagrant)
$ scp -P 2222 vagrant@127.0.0.1:/home/vagrant/.kube/config ~/.kube/config
vagrant@127.0.0.1's password: vagrant
config                                                                     100% 5449   118.7KB/s   00:00

List the Kubernetes cluster nodes using kubectl from your development host:
kubectl cluster-info

Deploy the Voter Application Microservices

kubectl create -f  /voting-app/k8s-specifications -n voting-microservices

